#!/bin/bash

# Obtenir le nom de la branche actuelle
branch_name=$(git rev-parse --abbrev-ref HEAD)
echo "Nom de la branche : $branch_name"

# Pattern des branches à vérifier
pattern="^(dev|main|feature/parsing|feature/execution-setup|feature/built.*)$"

if [[ ! "$branch_name" =~ $pattern ]]; then
    echo "La branche $branch_name ne correspond pas au pattern. Push autorisé."
    exit 0
fi

echo "La branche correspond au pattern. Vérification de la norme..."

# Vérification de la norme avec Norminette
DIRECTORY="./src ./libft"
OUTPUT=$(norminette $DIRECTORY)
echo "Résultat Norminette :"
echo "$OUTPUT"

if echo "$OUTPUT" | grep -q "Error"; then
    echo "Erreur : Le code ne respecte pas la norme."
    exit 1
fi

echo "Norme respectée."

# Test Valgrind uniquement sur certaines branches spécifiques
valgrind_branches="^(dev|main|feature/parsing|feature/execution-setup|feature/built.*)$"
if [[ "$branch_name" =~ $valgrind_branches ]]; then
    echo "Exécution des tests Valgrind..."
    make re
    if [ $? -ne 0 ]; then
        echo "Erreur : Échec de la compilation."
        make fclean
        exit 1
    fi

    valgrind --leak-check=full ./minishell
    if [ $? -ne 0 ]; then
        echo "Erreur : Tests Valgrind échoués."
        make fclean
        exit 1
    fi

    make fclean
    echo "Tests Valgrind réussis."
fi

echo "Push autorisé."
exit 0
