#!/bin/bash

# Rendre le hook exécutable (au cas où)
if [ ! -x ".githooks/pre-push" ]; then
    chmod +x .githooks/pre-push
fi

# Dossier à vérifier
DIRECTORY="."  # Remplace par le chemin de ton code

# Chemin de l'environnement virtuel
VENV_PATH="$HOME/.venv_norminette"

# Vérifier si Python est installé
if ! command -v python3 &> /dev/null; then
    echo "Erreur : Python 3 n'est pas installé."
    exit 1
fi

# Vérifier si l'environnement virtuel existe, sinon le créer
if [ ! -d "$VENV_PATH" ]; then
    echo "Création de l'environnement virtuel pour Norminette..."
    python3 -m venv $VENV_PATH
    if [ $? -ne 0 ]; then
        echo "Erreur : Impossible de créer l'environnement virtuel."
        exit 1
    fi
fi

# Activer l'environnement virtuel
source $VENV_PATH/bin/activate

# Vérifier si Norminette est installée, sinon l'installer
if ! command -v norminette &> /dev/null; then
    echo "Norminette n'est pas installée. Installation en cours..."
    pip install --upgrade pip setuptools
    pip install norminette
    if [ $? -ne 0 ]; then
        echo "Erreur : Impossible d'installer Norminette dans l'environnement virtuel."
        deactivate
        exit 1
    fi
fi

# Vérifier si Norminette est installée
if ! command -v norminette &> /dev/null; then
    echo "Norminette n'est pas installée. Installation en cours..."
    python3 -m pip install --user norminette
    if [ $? -ne 0 ]; then
        echo "Erreur : Impossible d'installer Norminette."
        exit 1
    fi
fi

# Vérification de la norme avec Norminette
echo "Vérification de la norme avec Norminette..."
OUTPUT=$(norminette $DIRECTORY)

# Vérifier si la norme est respectée après correction
if echo "$OUTPUT" | grep -q "Error"; then
    echo "Erreur : Le code ne respecte pas la norme."
    echo "$OUTPUT"
    exit 1
fi

echo "Norme respectée. Push autorisé."
exit 0
